<!doctype html>
<html>

    <head>
        <script>
            var canvas, context;
            var grid;
            var CANVAS_WIDTH = window.innerWidth, CANVAS_HEIGHT = window.innerHeight;
            var CELL_WIDTH = 32, CELL_HEIGHT = 32;
            var CELLS_WIDE = 15;
            var CELLS_HIGH = CANVAS_HEIGHT / CELL_HEIGHT;
            var colors = ["rgb(25,25,25)","rgb(155,155,155)"];
            var lastTick = 0;

            function wrap(val, max) {
                if (val >= max) return val % max;
                if (val < 0) return max + val;
                return val;
            }

            function shiftLeftMostBits(row) {
                row = row & 2863311530; //keep only even bits of a 32-bit integer
                row = row >> 1; //shift even bits into odd bits
                return row;
            }

            //values
            //0 - does nothing
            //1 - puts 1 in the right-most bit
            //2 - puts 1 in the left-most bit
            //3 - should never happen
            function flipCellBits(row, cell, value) {
                var bitMask = value << (cell * 2);

                //flip the bit in the row by XORing the bitmask
                row = row | bitMask;

                return row;
            }

            function getBit(value, digit) {
                return (value >> (digit * 2)) & 1;
            }

            function getNeighborCount(x, y) {
                var neighborCount = 0;
                for (var i = -1; i < 2; i++) {
                    for (var j = -1; j < 2; j++) {
                        if (i===0 && j===0) continue;
                        var nx = wrap(x + i, CELLS_WIDE);
                        var ny = wrap(y + j, CELLS_HIGH);

                        //only examine right-most bit
                        if (getBit(grid[ny], nx) === 1) {
                            neighborCount++;
                        }
                    }
                }
                return neighborCount;
            }

            //store new values in second bit so first bit remains untouched
            function liveOrDie(x, y) {
                var neighborCount = getNeighborCount(x, y);
                var value = getBit(grid[y], x);
                
                if (value === 0) { //cell is empty
                    if (neighborCount === 3)
                        return 2; //cell is born from 3 neighbors
                    else
                        return 0; //cell remains dead
                }
                else if (value === 1) { //cell is alive
                    if (neighborCount < 2 || neighborCount > 3)
                        return 0; //cell dies of overpopulation
                    else
                        return 2; //cell remains alive
                }
                else
                    console.error("error");
            }

            function nextGen() {
                for (var x=0; x<CELLS_WIDE; x++) {
                    for (var y=0; y<CELLS_HIGH; y++) {
                        grid[y] = flipCellBits(grid[y], x, liveOrDie(x, y));
                    }
                }

                //bitshift to get new values
                for (var y=0; y<CELLS_HIGH; y++) {
                    grid[y] = shiftLeftMostBits(grid[y]);
                }
            }

            function loop() {
                if (Date.now() > lastTick + 100) {
                    nextGen();
                    lastTick = Date.now();
                }

                draw();
                requestAnimationFrame(loop);
            }

            function draw() {
                context.fillStyle = "rgb(0,0,0)";
                context.fillRect(0,0,512,512);

                var dx, dy;
                var colorIndex;
                for (var x=0; x<CELLS_WIDE; x++) {
                    for (var y=0; y<CELLS_HIGH; y++) {
                        dx = x * CELL_WIDTH;
                        dy = y * CELL_HEIGHT;
                        colorIndex = getBit(grid[y], x); //draw right-most bit
                        context.fillStyle = colors[colorIndex];
                        context.fillRect(dx, dy, CELL_WIDTH, CELL_HEIGHT);

                        context.fillStyle = "rgb(0,0,255)";
                        //context.fillText(grid[0][x][y], dx, dy);
                    }
                }
            }

            function generateRandomCells(num) {
                for (var i=0; i<num; i++) {
                    var randX = Math.floor(Math.random() * CELLS_WIDE);
                    var randY = Math.floor(Math.random() * CELLS_HIGH);
                    grid[randY] = flipCellBits(grid[randY], randX, 1);
                }
            }

            function mouse_down(e) {
                var cellX = Math.floor(e.offsetX / CELL_WIDTH);
                var cellY = Math.floor(e.offsetY / CELL_HEIGHT);
                flipCellBits(grid[cellY], cellX, 2);
                nextGen();
            }

            function mouse_move(e) {
                var cellX = Math.floor(e.offsetX / CELL_WIDTH);
                var cellY = Math.floor(e.offsetY / CELL_HEIGHT);
                console.log(liveOrDie(cellX,cellY));
            }

            function init() {
                grid = [];
                for (var y=0; y<CELLS_HIGH; y++) {
                    grid[y] = 0;
                }

                generateRandomCells(100);

                requestAnimationFrame(loop);
            }

            window.onload = function() {
                canvas = document.getElementById("canvas");
                canvas.width = CANVAS_WIDTH;
                canvas.height = CANVAS_HEIGHT;
                canvas.onmousedown = mouse_down;
                canvas.onmousemove = mouse_move;

                context = canvas.getContext("2d");
                context.textBaseline = "top";
                context.font = "16px Arial";

                init();
            };

            window.onresize = function() {
                init();
            };

        </script>
    </head>

    <body>
        <canvas id="canvas" width="512" height="512"></canvas>
    </body>

</html>